name: Desktop Release - Auto-Update & Code Signing

on:
  push:
    tags:
      - 'v*'
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    paths: ['installer/**', 'apps/pwa-shell/**', 'packages/**']
  workflow_dispatch:
    inputs:
      release_channel:
        description: 'Release channel'
        required: true
        default: 'latest'
        type: choice
        options:
          - latest
          - beta
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      force_rebuild:
        description: 'Force rebuild all platforms'
        required: false
        type: boolean
        default: false

env:
  GRAHMOS_VERSION: 2.0.0
  NODE_VERSION: '20'
  ELECTRON_CACHE: ~/.cache/electron
  ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

jobs:
  # Build matrix for desktop installers
  build-desktop:
    name: Build Desktop - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows builds
          - platform: windows
            os: windows-latest
            arch: x64
            target: nsis,msi,portable
          - platform: windows
            os: windows-latest
            arch: arm64
            target: nsis,portable
          
          # macOS builds
          - platform: macos
            os: macos-latest
            arch: x64
            target: dmg,zip
          - platform: macos
            os: macos-latest
            arch: arm64
            target: dmg,zip
          
          # Linux builds
          - platform: linux
            os: ubuntu-latest
            arch: x64
            target: AppImage,deb,rpm,snap
          - platform: linux
            os: ubuntu-latest
            arch: arm64
            target: AppImage,deb,rpm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup PNPM (for workspace dependencies)
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.4
          run_install: false
      
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: ${{ env.ELECTRON_CACHE }}
          key: ${{ runner.os }}-electron-${{ hashFiles('installer/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-
      
      - name: Cache Electron Builder
        uses: actions/cache@v4
        with:
          path: ${{ env.ELECTRON_BUILDER_CACHE }}
          key: ${{ runner.os }}-electron-builder-${{ hashFiles('installer/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-builder-
      
      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build PWA shell
        run: |
          cd apps/pwa-shell
          pnpm run build
      
      - name: Build assistant package
        run: |
          cd packages/assistant
          pnpm run build
      
      - name: Install installer dependencies
        working-directory: installer
        run: npm ci
      
      # Platform-specific setup
      - name: Setup Windows signing (Windows only)
        if: matrix.platform == 'windows'
        run: |
          # Import code signing certificate
          if ($env:WINDOWS_CERT_P12) {
            $bytes = [Convert]::FromBase64String($env:WINDOWS_CERT_P12)
            [IO.File]::WriteAllBytes("cert.p12", $bytes)
            echo "CSC_LINK=cert.p12" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "CSC_KEY_PASSWORD=$env:WINDOWS_CERT_PASSWORD" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
        env:
          WINDOWS_CERT_P12: ${{ secrets.WINDOWS_CERT_P12 }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        shell: pwsh
      
      - name: Setup macOS signing (macOS only)
        if: matrix.platform == 'macos'
        run: |
          # Import Apple certificates
          if [ -n "$APPLE_CERT_P12" ]; then
            echo $APPLE_CERT_P12 | base64 --decode > cert.p12
            security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security import cert.p12 -k build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
            
            echo "CSC_LINK=cert.p12" >> $GITHUB_ENV
            echo "CSC_KEY_PASSWORD=$APPLE_CERT_PASSWORD" >> $GITHUB_ENV
          fi
        env:
          APPLE_CERT_P12: ${{ secrets.APPLE_CERT_P12 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      
      - name: Setup Linux dependencies (Linux only)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2-dev libxcomposite-dev libxdamage-dev libxrandr-dev libgbm-dev libxss1-dev libasound2-dev
          
          # For Snap builds
          if [[ "${{ matrix.target }}" == *"snap"* ]]; then
            sudo apt-get install -y snapd
            sudo snap install snapcraft --classic
          fi
      
      - name: Set release channel
        run: |
          if [[ "${{ github.event.inputs.release_channel }}" != "" ]]; then
            echo "GRAHMOS_RELEASE_CHANNEL=${{ github.event.inputs.release_channel }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "GRAHMOS_RELEASE_CHANNEL=latest" >> $GITHUB_ENV
          else
            echo "GRAHMOS_RELEASE_CHANNEL=beta" >> $GITHUB_ENV
          fi
        shell: bash
      
      - name: Build desktop installer
        working-directory: installer
        run: |
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            npm run build:windows -- --${{ matrix.arch }} --targets ${{ matrix.target }}
          elif [[ "${{ matrix.platform }}" == "macos" ]]; then
            npm run build:macos -- --${{ matrix.arch }} --targets ${{ matrix.target }}
          else
            npm run build:linux -- --${{ matrix.arch }} --targets ${{ matrix.target }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        shell: bash
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: grahmos-desktop-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            installer/build/*.exe
            installer/build/*.msi
            installer/build/*.dmg
            installer/build/*.zip
            installer/build/*.AppImage
            installer/build/*.deb
            installer/build/*.rpm
            installer/build/*.snap
            installer/build/*.tar.gz
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Generate checksums
        working-directory: installer/build
        run: |
          for file in *; do
            if [[ -f "$file" ]]; then
              sha256sum "$file" > "$file.sha256"
            fi
          done
        shell: bash
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums-${{ matrix.platform }}-${{ matrix.arch }}
          path: installer/build/*.sha256
          if-no-files-found: ignore

  # Test desktop installers
  test-desktop:
    name: Test Desktop - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: build-desktop
    if: github.event_name == 'pull_request'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest
          - platform: linux
            os: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: grahmos-desktop-${{ matrix.platform }}-x64
          path: installer/build
      
      - name: Test installer (Windows)
        if: matrix.platform == 'windows'
        run: |
          # Test NSIS installer in silent mode
          $installer = Get-ChildItem installer/build/*.exe | Select-Object -First 1
          if ($installer) {
            Write-Host "Testing installer: $($installer.Name)"
            # Run installer in silent mode for testing
            # Start-Process -FilePath $installer.FullName -ArgumentList "/S" -Wait -NoNewWindow
            Write-Host "Installer test completed"
          }
        shell: pwsh
      
      - name: Test installer (macOS)
        if: matrix.platform == 'macos'
        run: |
          # Test DMG mounting
          dmg_file=$(find installer/build -name "*.dmg" | head -n 1)
          if [ -f "$dmg_file" ]; then
            echo "Testing DMG: $dmg_file"
            hdiutil attach "$dmg_file" -readonly -mountpoint /tmp/grahmos_test
            ls -la /tmp/grahmos_test
            hdiutil detach /tmp/grahmos_test
            echo "DMG test completed"
          fi
      
      - name: Test installer (Linux)
        if: matrix.platform == 'linux'
        run: |
          # Test AppImage
          appimage_file=$(find installer/build -name "*.AppImage" | head -n 1)
          if [ -f "$appimage_file" ]; then
            echo "Testing AppImage: $appimage_file"
            chmod +x "$appimage_file"
            # Test that AppImage can extract itself
            "$appimage_file" --appimage-extract-and-run --help || true
            echo "AppImage test completed"
          fi
          
          # Test DEB package
          deb_file=$(find installer/build -name "*.deb" | head -n 1)
          if [ -f "$deb_file" ]; then
            echo "Testing DEB: $deb_file"
            dpkg-deb --info "$deb_file"
            dpkg-deb --contents "$deb_file"
            echo "DEB test completed"
          fi

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-desktop
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.release_channel != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find release-artifacts -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.snap" -o -name "*.sha256" \) -exec cp {} release-assets/ \;
          
          # Create latest.yml and latest-mac.yml for auto-updater
          cd release-assets
          ls -la
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract changelog for current version
            changelog=$(sed -n "/^## \[$(echo $GITHUB_REF | sed 's/refs\/tags\///')]$/,/^## \[/p" CHANGELOG.md | head -n -1)
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "$changelog" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=Automated release from CI/CD" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || format('v{0}', env.GRAHMOS_VERSION) }}
          release_name: Grahmos Desktop ${{ github.ref_name || env.GRAHMOS_VERSION }}
          body: |
            # Grahmos Desktop Release
            
            ## What's New
            ${{ steps.changelog.outputs.CHANGELOG || 'Automated release with latest updates and improvements.' }}
            
            ## Installation
            
            ### Windows
            - **Recommended**: Download and run `Grahmos-Setup-*.exe` (NSIS installer)
            - **Alternative**: Download `Grahmos-*.msi` (MSI installer)
            - **Portable**: Download `Grahmos-*-win.exe` (portable version)
            
            ### macOS
            - **Recommended**: Download `Grahmos-*.dmg` and drag to Applications folder
            - **Alternative**: Download `Grahmos-*-mac.zip` and extract
            
            ### Linux
            - **AppImage**: Download `Grahmos-*.AppImage`, make executable, and run
            - **Debian/Ubuntu**: Download and install `grahmos_*.deb`
            - **RHEL/CentOS**: Download and install `grahmos-*.rpm`
            - **Snap**: `snap install grahmos`
            
            ## Verification
            All releases are signed and include SHA256 checksums. Verify downloads:
            ```bash
            sha256sum -c Grahmos-*.sha256
            ```
            
            ## Auto-Updates
            This version supports automatic updates. The application will notify you when updates are available.
            
            **Release Channel**: ${{ env.GRAHMOS_RELEASE_CHANNEL || 'latest' }}
          draft: false
          prerelease: ${{ env.GRAHMOS_RELEASE_CHANNEL == 'beta' }}
      
      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release-assets
          asset_name: grahmos-desktop-assets
          asset_content_type: application/zip

  # Update release server
  update-release-server:
    name: Update Release Server
    runs-on: ubuntu-latest
    needs: create-release
    if: success()
    
    steps:
      - name: Trigger release server update
        run: |
          curl -X POST "${{ secrets.RELEASE_SERVER_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RELEASE_SERVER_TOKEN }}" \
            -d '{
              "version": "${{ env.GRAHMOS_VERSION }}",
              "channel": "${{ env.GRAHMOS_RELEASE_CHANNEL }}",
              "tag": "${{ github.ref_name }}",
              "assets_url": "${{ steps.create_release.outputs.upload_url }}"
            }' || echo "Release server update failed, continuing..."

  # Notify deployment
  notify-completion:
    name: Notify Release Completion
    runs-on: ubuntu-latest
    needs: [build-desktop, create-release, update-release-server]
    if: always()
    
    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#releases'
          text: |
            üöÄ Grahmos Desktop Release Pipeline
            
            üì¶ Version: ${{ env.GRAHMOS_VERSION }}
            üè∑Ô∏è  Tag: ${{ github.ref_name }}
            üìä Status: ${{ job.status }}
            üåü Channel: ${{ env.GRAHMOS_RELEASE_CHANNEL }}
            
            Platform Support:
            ‚Ä¢ ‚úÖ Windows (x64, arm64)
            ‚Ä¢ ‚úÖ macOS (Intel, Apple Silicon) 
            ‚Ä¢ ‚úÖ Linux (AppImage, DEB, RPM, Snap)
            
            Auto-update enabled for all platforms.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Skip Slack notification
        if: env.SLACK_WEBHOOK_URL == ''
        run: echo "‚ö†Ô∏è  Slack webhook not configured, skipping notification"
